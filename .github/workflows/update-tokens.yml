name: Update Design Tokens

on:
  repository_dispatch:
    types: [update-tokens]

jobs:
  transform-tokens:
    name: Transform Figma design tokens to SCSS
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create tokens directory
        run: mkdir -p tokens
      
      - name: Create JSON from request body
        id: create-json
        uses: jsdaniell/create-json@v1.2.3
        with:
          name: ${{ github.event.client_payload.filename }}
          json: ${{ github.event.client_payload.tokens }}
          dir: 'tokens'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Transform tokens
        run: pnpm run build-tokens tokens/${{ github.event.client_payload.filename }}
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: ${{ github.event.client_payload.commitMessage || 'Update design tokens from Figma' }}
          title: "Design tokens updated from Figma"
          body: "Design tokens have been updated via Figma and need to be reviewed."
          branch: design-tokens-update
          delete-branch: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
